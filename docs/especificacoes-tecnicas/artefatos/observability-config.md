# Especifica√ß√£o T√©cnica: Configura√ß√£o de Observabilidade

## üìÅ Artefato

**Caminho:** `config/observability.yaml`

## üéØ Objetivo

Criar arquivos de configura√ß√£o centralizados para todos os componentes de observabilidade, permitindo configura√ß√£o flex√≠vel de logging, m√©tricas, tracing e exportadores por ambiente (dev, staging, prod).

## üìö Instru√ß√µes Relacionadas

- **observabilidade.instructions.md** - Padr√µes de configura√ß√£o e nomenclatura
- **python-mcp.instructions.md** - Padr√µes de configura√ß√£o em projetos Python
- **api-security.instructions.md** - N√£o expor dados sens√≠veis em configura√ß√µes

## üé® Prompts Relacionados

- **observabilidade.prompt.md** - Configura√ß√£o de OpenTelemetry
- **clean-architecture.prompt.md** - Organiza√ß√£o de configura√ß√µes

## üéØ Chat Mode Recomendado

- **arquiteto.chatmode.md** - Para defini√ß√£o de padr√µes de configura√ß√£o

## üèóÔ∏è Estrutura de Arquivos

```
config/
‚îú‚îÄ‚îÄ observability.yaml           # Configura√ß√£o principal
‚îú‚îÄ‚îÄ environments/
‚îÇ   ‚îú‚îÄ‚îÄ development.yaml        # Configura√ß√µes de desenvolvimento
‚îÇ   ‚îú‚îÄ‚îÄ staging.yaml            # Configura√ß√µes de staging
‚îÇ   ‚îî‚îÄ‚îÄ production.yaml         # Configura√ß√µes de produ√ß√£o
‚îî‚îÄ‚îÄ exporters/
    ‚îú‚îÄ‚îÄ prometheus.yaml         # Configura√ß√£o Prometheus
    ‚îú‚îÄ‚îÄ jaeger.yaml            # Configura√ß√£o Jaeger
    ‚îî‚îÄ‚îÄ loki.yaml              # Configura√ß√£o Loki
```

## üõ†Ô∏è Implementa√ß√£o de Configura√ß√µes

### 1. Configura√ß√£o Principal (`config/observability.yaml`)

```yaml
# Configura√ß√£o principal de observabilidade
observability:
  service:
    name: "skyhal-api"
    version: "0.1.0"
    environment: "${ENVIRONMENT:development}"
    instance_id: "${HOSTNAME:localhost}"

  # Configura√ß√£o de Logging
  logging:
    level: "${LOG_LEVEL:INFO}"
    format: "json"
    structured: true
    include_trace_info: true
    sanitize_sensitive_data: true

    fields:
      service_name: "${SERVICE_NAME:skyhal-api}"
      service_version: "${SERVICE_VERSION:0.1.0}"
      environment: "${ENVIRONMENT:development}"

    sensitive_fields:
      - password
      - token
      - secret
      - key
      - authorization
      - x-api-key

  # Configura√ß√£o de M√©tricas
  metrics:
    enabled: true
    prefix: "skyhal"

    # M√©tricas RED (Rate, Errors, Duration)
    red_metrics:
      enabled: true
      request_counter: "http_requests_total"
      error_counter: "http_errors_total"
      duration_histogram: "http_request_duration_seconds"

    # M√©tricas customizadas
    custom_metrics:
      enabled: true
      business_metrics: true
      system_metrics: true

    # Configura√ß√£o de Labels
    default_labels:
      service: "${SERVICE_NAME:skyhal-api}"
      version: "${SERVICE_VERSION:0.1.0}"
      environment: "${ENVIRONMENT:development}"

  # Configura√ß√£o de Tracing
  tracing:
    enabled: true
    sampling_ratio: "${TRACING_SAMPLING_RATIO:0.1}"

    # Instrumenta√ß√µes autom√°ticas
    auto_instrumentation:
      fastapi: true
      sqlalchemy: true
      requests: true
      logging: true

    # Configura√ß√£o de Spans
    span_config:
      max_attributes: 128
      max_events: 128
      max_links: 128
      attribute_value_length_limit: 512

    # Recursos inclu√≠dos
    resource_attributes:
      service.name: "${SERVICE_NAME:skyhal-api}"
      service.version: "${SERVICE_VERSION:0.1.0}"
      service.environment: "${ENVIRONMENT:development}"
      service.instance.id: "${HOSTNAME:localhost}"

  # Configura√ß√£o de Exportadores
  exporters:
    prometheus:
      enabled: true
      port: "${PROMETHEUS_PORT:8000}"
      path: "/metrics"
      include_target_info: true

    jaeger:
      enabled: true
      endpoint: "${JAEGER_ENDPOINT:http://localhost:14268/api/traces}"
      timeout: 30
      compression: "gzip"

    otlp:
      enabled: false
      endpoint: "${OTLP_ENDPOINT:http://localhost:4317}"
      insecure: true
      timeout: 30

    loki:
      enabled: false
      endpoint: "${LOKI_ENDPOINT:http://localhost:3100/loki/api/v1/push}"
      tenant_id: "${LOKI_TENANT_ID:}"

  # Configura√ß√£o de Health Checks
  health_checks:
    enabled: true
    endpoint: "/health"
    detailed_endpoint: "/health/detailed"

    checks:
      - name: "observability_stack"
        enabled: true
      - name: "metrics_exporter"
        enabled: true
      - name: "tracing_exporter"
        enabled: true
```

### 2. Configura√ß√£o de Desenvolvimento (`config/environments/development.yaml`)

```yaml
# Configura√ß√µes espec√≠ficas para desenvolvimento
observability:
  logging:
    level: "DEBUG"

  metrics:
    red_metrics:
      enabled: true
    custom_metrics:
      business_metrics: false  # Desabilitado em dev
      system_metrics: true

  tracing:
    sampling_ratio: 1.0  # 100% sampling em dev

  exporters:
    prometheus:
      enabled: true
      port: 8000

    jaeger:
      enabled: true
      endpoint: "http://localhost:14268/api/traces"

    otlp:
      enabled: false

    loki:
      enabled: false

# Configura√ß√µes de infraestrutura local
infrastructure:
  jaeger:
    ui_port: 16686
    collector_port: 14268

  prometheus:
    ui_port: 9090
    scrape_interval: "15s"

  grafana:
    ui_port: 3000
    admin_user: "admin"
    admin_password: "admin"
```

### 3. Configura√ß√£o de Produ√ß√£o (`config/environments/production.yaml`)

```yaml
# Configura√ß√µes espec√≠ficas para produ√ß√£o
observability:
  logging:
    level: "INFO"

  metrics:
    red_metrics:
      enabled: true
    custom_metrics:
      business_metrics: true
      system_metrics: true

  tracing:
    sampling_ratio: 0.01  # 1% sampling em produ√ß√£o

  exporters:
    prometheus:
      enabled: true
      port: 8000

    jaeger:
      enabled: true
      endpoint: "${JAEGER_ENDPOINT}"

    otlp:
      enabled: true
      endpoint: "${OTLP_ENDPOINT}"

    loki:
      enabled: true
      endpoint: "${LOKI_ENDPOINT}"
      tenant_id: "${LOKI_TENANT_ID}"

# Configura√ß√µes de alertas
alerts:
  enabled: true

  rules:
    high_error_rate:
      enabled: true
      threshold: 0.05  # 5% error rate
      duration: "5m"

    high_latency:
      enabled: true
      threshold: 0.5   # 500ms
      percentile: 95
      duration: "2m"

    low_availability:
      enabled: true
      threshold: 0.99  # 99% availability
      duration: "1m"

# Configura√ß√µes de reten√ß√£o
retention:
  metrics: "30d"
  traces: "7d"
  logs: "14d"
```

### 4. Configura√ß√£o Prometheus (`config/exporters/prometheus.yaml`)

```yaml
# Configura√ß√£o espec√≠fica do exportador Prometheus
prometheus:
  global:
    scrape_interval: 15s
    evaluation_interval: 15s

  scrape_configs:
    - job_name: 'skyhal-api'
      static_configs:
        - targets: ['localhost:8000']
      metrics_path: '/metrics'
      scrape_interval: 5s

      metric_relabel_configs:
        # Manter apenas m√©tricas relevantes
        - source_labels: [__name__]
          regex: 'skyhal_.*|http_.*|process_.*'
          action: keep

  # Regras de agrega√ß√£o
  rule_files:
    - "rules/*.yml"

  # Configura√ß√£o de alertas
  alerting:
    alertmanagers:
      - static_configs:
          - targets:
            - alertmanager:9093
```

## üîß Classe de Configura√ß√£o Python

### `src/infrastructure/config/observability_config.py`

```python
from typing import Dict, Any, Optional
import yaml
import os
from pydantic import BaseSettings, Field
from pathlib import Path

class ObservabilityConfig(BaseSettings):
    """Configura√ß√£o de observabilidade baseada em arquivos YAML."""

    # Configura√ß√µes do servi√ßo
    service_name: str = Field(default="skyhal-api", env="SERVICE_NAME")
    service_version: str = Field(default="0.1.0", env="SERVICE_VERSION")
    environment: str = Field(default="development", env="ENVIRONMENT")

    # Configura√ß√µes de logging
    log_level: str = Field(default="INFO", env="LOG_LEVEL")

    # Configura√ß√µes de tracing
    tracing_sampling_ratio: float = Field(default=0.1, env="TRACING_SAMPLING_RATIO")

    # Configura√ß√µes de exportadores
    prometheus_port: int = Field(default=8000, env="PROMETHEUS_PORT")
    jaeger_endpoint: str = Field(
        default="http://localhost:14268/api/traces",
        env="JAEGER_ENDPOINT"
    )

    def __init__(self, config_path: Optional[str] = None):
        super().__init__()
        self._config_data = self._load_config(config_path)

    def _load_config(self, config_path: Optional[str] = None) -> Dict[str, Any]:
        """Carrega configura√ß√£o dos arquivos YAML."""
        if not config_path:
            config_path = Path(__file__).parent.parent.parent.parent / "config"

        config_path = Path(config_path)

        # Carrega configura√ß√£o principal
        main_config_file = config_path / "observability.yaml"
        with open(main_config_file, 'r', encoding='utf-8') as f:
            config = yaml.safe_load(f)

        # Carrega configura√ß√£o espec√≠fica do ambiente
        env_config_file = config_path / "environments" / f"{self.environment}.yaml"
        if env_config_file.exists():
            with open(env_config_file, 'r', encoding='utf-8') as f:
                env_config = yaml.safe_load(f)
                self._merge_configs(config, env_config)

        return config

    def _merge_configs(self, base: Dict[str, Any], override: Dict[str, Any]) -> None:
        """Merge configura√ß√µes, priorizando override."""
        for key, value in override.items():
            if key in base and isinstance(base[key], dict) and isinstance(value, dict):
                self._merge_configs(base[key], value)
            else:
                base[key] = value

    def get_config(self, path: str, default: Any = None) -> Any:
        """Obt√©m configura√ß√£o usando nota√ß√£o de pontos."""
        keys = path.split('.')
        value = self._config_data

        for key in keys:
            if isinstance(value, dict) and key in value:
                value = value[key]
            else:
                return default

        return value

    @property
    def is_metrics_enabled(self) -> bool:
        """Verifica se m√©tricas est√£o habilitadas."""
        return self.get_config('observability.metrics.enabled', True)

    @property
    def is_tracing_enabled(self) -> bool:
        """Verifica se tracing est√° habilitado."""
        return self.get_config('observability.tracing.enabled', True)

    @property
    def sensitive_fields(self) -> list:
        """Retorna lista de campos sens√≠veis."""
        return self.get_config('observability.logging.sensitive_fields', [])
```

## ‚úÖ Checklist de Implementa√ß√£o

- [ ] Criar arquivo de configura√ß√£o principal `observability.yaml`
- [ ] Criar configura√ß√µes por ambiente (dev, staging, prod)
- [ ] Criar configura√ß√µes espec√≠ficas de exportadores
- [ ] Implementar classe Python para carregamento de configura√ß√µes
- [ ] Configurar vari√°veis de ambiente para diferentes ambientes
- [ ] Validar configura√ß√µes com diferentes cen√°rios
- [ ] Documentar todas as op√ß√µes de configura√ß√£o
- [ ] Implementar testes de carregamento de configura√ß√£o
- [ ] Configurar valida√ß√£o de schema das configura√ß√µes

## üîó Depend√™ncias de Outros Artefatos

- **observability-infrastructure.md** - Usa configura√ß√µes definidas aqui
- **observability-middleware.md** - Aplica configura√ß√µes de instrumenta√ß√£o
- **grafana-setup.md** - Usa configura√ß√µes de exportadores

## üìù Notas T√©cnicas

- Usar vari√°veis de ambiente para configura√ß√µes sens√≠veis
- Configura√ß√µes podem ser sobrescritas por ambiente
- Valida√ß√£o de schema garante integridade das configura√ß√µes
- Suporte a hot-reload para desenvolvimento
- Configura√ß√µes s√£o centralizadas mas modulares por componente
